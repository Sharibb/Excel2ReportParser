"""Pydantic models for vulnerability data structures."""

from enum import Enum
from typing import List, Optional

from pydantic import BaseModel, Field, field_validator


class RiskLevel(str, Enum):
    """Vulnerability risk levels."""

    CRITICAL = "Critical"
    HIGH = "High"
    MEDIUM = "Medium"
    LOW = "Low"
    INFORMATIONAL = "Informational"


class Vulnerability(BaseModel):
    """Core vulnerability data model."""

    vuln_id: str = Field(..., description="Vulnerability ID (e.g., H1, M2, L3)")
    title: str = Field(..., description="Vulnerability title")
    description: str = Field(..., description="Detailed description")
    risk_level: RiskLevel = Field(..., description="Risk severity level")
    cvss_score: Optional[str] = Field(None, description="CVSS score with vector")
    affected_components: str = Field(..., description="Affected systems/components")
    recommendation: str = Field(..., description="Remediation recommendation")
    poc_folder: Optional[str] = Field(None, description="Proof of Concept folder name")
    steps: List[str] = Field(default_factory=list, description="PoC step image filenames")
    cwe_id: Optional[str] = Field(None, description="CWE ID(s)")
    impact: Optional[str] = Field(None, description="Security impact description")
    references: Optional[str] = Field(None, description="External references")
    remediation_effort: Optional[str] = Field(None, description="Remediation effort level")

    @field_validator("vuln_id")
    @classmethod
    def validate_vuln_id(cls, v: str) -> str:
        """Validate vulnerability ID format (H1, M1, L1, etc.)."""
        if not v:
            raise ValueError("Vulnerability ID cannot be empty")

        # Check format: starts with C/H/M/L/I followed by digits
        prefix = v[0].upper()
        if prefix not in ["C", "H", "M", "L", "I"]:
            raise ValueError(
                f"Invalid vulnerability ID prefix: {prefix}. "
                "Must be C (Critical), H (High), M (Medium), L (Low), or I (Informational)"
            )

        if len(v) < 2 or not v[1:].isdigit():
            raise ValueError(
                f"Invalid vulnerability ID format: {v}. "
                "Expected format: [C|H|M|L|I]<number> (e.g., H1, M2)"
            )

        return v.upper()

    class Config:
        """Pydantic model configuration."""

        use_enum_values = True


class VulnerabilityExcelRow(BaseModel):
    """Model representing a vulnerability as it appears in Excel."""

    vulnerability_id: str = Field(..., alias="Vulnerability ID")
    title: str = Field(..., alias="Title")
    description: str = Field(..., alias="Description")
    risk_level: str = Field(..., alias="Risk Level")
    cvss_score: Optional[str] = Field(None, alias="CVSS Score")
    affected_components: str = Field(..., alias="Affected Components")
    recommendation: str = Field(..., alias="Recommendation")
    poc_folder: Optional[str] = Field(None, alias="POC_Folder")
    step1: Optional[str] = Field(None, alias="Step1")
    step2: Optional[str] = Field(None, alias="Step2")
    step3: Optional[str] = Field(None, alias="Step3")
    step4: Optional[str] = Field(None, alias="Step4")
    step5: Optional[str] = Field(None, alias="Step5")
    step6: Optional[str] = Field(None, alias="Step6")
    step7: Optional[str] = Field(None, alias="Step7")
    step8: Optional[str] = Field(None, alias="Step8")
    step9: Optional[str] = Field(None, alias="Step9")
    step10: Optional[str] = Field(None, alias="Step10")
    cwe_id: Optional[str] = Field(None, alias="CWE ID")
    impact: Optional[str] = Field(None, alias="Impact")
    references: Optional[str] = Field(None, alias="References")
    remediation_effort: Optional[str] = Field(None, alias="Remediation Effort")

    def to_vulnerability(self) -> Vulnerability:
        """Convert Excel row to Vulnerability model."""
        # Collect all step columns
        steps = []
        for i in range(1, 11):
            step_value = getattr(self, f"step{i}", None)
            if step_value:
                steps.append(step_value)

        # Map risk level string to enum
        risk_mapping = {
            "CRITICAL": RiskLevel.CRITICAL,
            "HIGH": RiskLevel.HIGH,
            "MEDIUM": RiskLevel.MEDIUM,
            "LOW": RiskLevel.LOW,
            "INFORMATIONAL": RiskLevel.INFORMATIONAL,
        }
        risk_level = risk_mapping.get(
            self.risk_level.upper(), RiskLevel.INFORMATIONAL
        )

        return Vulnerability(
            vuln_id=self.vulnerability_id,
            title=self.title,
            description=self.description,
            risk_level=risk_level,
            cvss_score=self.cvss_score,
            affected_components=self.affected_components,
            recommendation=self.recommendation,
            poc_folder=self.poc_folder,
            steps=steps,
            cwe_id=self.cwe_id,
            impact=self.impact,
            references=self.references,
            remediation_effort=self.remediation_effort,
        )

    class Config:
        """Pydantic model configuration."""

        populate_by_name = True


class VulnerabilityReport(BaseModel):
    """Complete vulnerability report containing multiple vulnerabilities."""

    report_title: str = Field(..., description="Report title")
    vulnerabilities: List[Vulnerability] = Field(
        default_factory=list, description="List of vulnerabilities"
    )
    total_count: int = Field(0, description="Total vulnerability count")
    critical_count: int = Field(0, description="Critical vulnerabilities")
    high_count: int = Field(0, description="High vulnerabilities")
    medium_count: int = Field(0, description="Medium vulnerabilities")
    low_count: int = Field(0, description="Low vulnerabilities")
    info_count: int = Field(0, description="Informational vulnerabilities")

    def calculate_counts(self) -> None:
        """Calculate vulnerability counts by risk level."""
        self.total_count = len(self.vulnerabilities)
        self.critical_count = sum(
            1 for v in self.vulnerabilities if v.risk_level == RiskLevel.CRITICAL
        )
        self.high_count = sum(
            1 for v in self.vulnerabilities if v.risk_level == RiskLevel.HIGH
        )
        self.medium_count = sum(
            1 for v in self.vulnerabilities if v.risk_level == RiskLevel.MEDIUM
        )
        self.low_count = sum(
            1 for v in self.vulnerabilities if v.risk_level == RiskLevel.LOW
        )
        self.info_count = sum(
            1 for v in self.vulnerabilities if v.risk_level == RiskLevel.INFORMATIONAL
        )
